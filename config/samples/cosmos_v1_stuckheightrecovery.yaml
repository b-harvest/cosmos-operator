apiVersion: cosmos.bharvest.io/v1
kind: StuckHeightRecovery
metadata:
  name: stuckheightrecovery-sample
spec:
  # Required: Reference to the CosmosFullNode to monitor
  fullNodeRef:
    name: cosmoshub

  # Required: Duration to wait before considering height as stuck
  # Examples: "5m", "10m", "1h"
  stuckDuration: "10m"

  # Required: Recovery script to execute
  # The script has access to these environment variables:
  # - POD_NAME: Name of the stuck pod
  # - POD_NAMESPACE: Namespace of the stuck pod
  # - CURRENT_HEIGHT: Current height of the stuck pod
  # - PVC_NAME: Name of the PVC
  # - CHAIN_HOME: Home directory of the chain (/chain-home)
  recoveryScript: |
    #!/bin/sh
    set -e

    echo "Starting recovery for pod: $POD_NAME"
    echo "Current height: $CURRENT_HEIGHT"
    echo "Chain home: $CHAIN_HOME"

    # Example: Remove address book to force peer refresh
    if [ -f "$CHAIN_HOME/config/addrbook.json" ]; then
      echo "Removing addrbook.json to force peer refresh"
      rm -f "$CHAIN_HOME/config/addrbook.json"
    fi

    # Example: Remove any lock files
    if [ -f "$CHAIN_HOME/data/LOCK" ]; then
      echo "Removing LOCK file"
      rm -f "$CHAIN_HOME/data/LOCK"
    fi

    echo "Recovery script completed successfully"

  # Optional: Create VolumeSnapshot before recovery
  createVolumeSnapshot: true
  volumeSnapshotClassName: "csi-snapshot-class"

  # Optional: Rate limiting configuration
  maxRetries: 3
  rateLimitWindow: "5m"

  # Optional: Suspend recovery operations
  suspend: false

---
apiVersion: cosmos.bharvest.io/v1
kind: StuckHeightRecovery
metadata:
  name: stuckheightrecovery-advanced
spec:
  fullNodeRef:
    name: cosmoshub

  stuckDuration: "15m"

  # Advanced recovery script with more operations
  recoveryScript: |
    #!/bin/sh
    set -e

    echo "=== Advanced Recovery Script ==="
    echo "Pod: $POD_NAME"
    echo "Namespace: $POD_NAMESPACE"
    echo "Current Height: $CURRENT_HEIGHT"
    echo "PVC: $PVC_NAME"
    echo "Chain Home: $CHAIN_HOME"

    # Clean up lock files
    echo "Cleaning up lock files..."
    find "$CHAIN_HOME/data" -name "LOCK" -delete || true

    # Remove WAL files if they exist
    echo "Checking WAL files..."
    if [ -d "$CHAIN_HOME/data/cs.wal" ]; then
      echo "Removing consensus WAL..."
      rm -rf "$CHAIN_HOME/data/cs.wal" || true
    fi

    # Reset addrbook
    echo "Resetting addrbook..."
    rm -f "$CHAIN_HOME/config/addrbook.json" || true

    # Optional: Reset private validator state (use with caution!)
    # echo "Resetting priv_validator_state.json..."
    # echo '{"height":"0","round":0,"step":0}' > "$CHAIN_HOME/data/priv_validator_state.json"

    echo "=== Recovery Complete ==="

  # Custom pod template with specific image and resources
  podTemplate:
    image: "alpine:3.18"
    imagePullPolicy: IfNotPresent
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    # Additional environment variables
    env:
      - name: DEBUG
        value: "true"
      - name: RECOVERY_MODE
        value: "aggressive"
    # Additional volumes (if needed)
    # volumes:
    #   - name: custom-scripts
    #     configMap:
    #       name: recovery-scripts
    # volumeMounts:
    #   - name: custom-scripts
    #     mountPath: /scripts

  # Create snapshot before recovery
  createVolumeSnapshot: true
  volumeSnapshotClassName: "csi-snapshot-class"

  # Allow up to 5 attempts within 10 minutes
  maxRetries: 5
  rateLimitWindow: "10m"

  suspend: false
